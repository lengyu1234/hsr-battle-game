<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ˜Ÿç©¹é“é“æ¨¡æ‹Ÿå™¨ (å›¾ç‰‡ç«‹ç»˜ç‰ˆ)</title>
    <style>
        /* === æ ·å¼è¡¨ === */
        :root {
            --bg-color: #0d1117;
            --ui-panel: rgba(22, 27, 34, 0.95);
            --sp-color: #ffd700;
            --hp-color: #2ecc71;
            --shield-color: #5dade2;
            --enemy-hp: #e74c3c;
            --toughness-color: #ecf0f1;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        /* å·¦ä¾§è¡ŒåŠ¨æ¡ */
        #action-bar-container {
            width: 110px;
            background: rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 1px solid #333;
            z-index: 10;
        }

        .action-card {
            background: #2c3e50;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 2px solid transparent;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: center;
        }
        
        .action-card img {
            width: 20px; height: 20px; border-radius: 50%; object-fit: cover;
        }

        .action-card.active {
            border-color: var(--sp-color);
            background: #34495e;
            transform: scale(1.05);
        }

        /* æˆ˜æ–—ä¸»åŒºåŸŸ */
        #battle-field {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
        }

        .enemy-group { display: flex; gap: 30px; margin-bottom: 120px; }
        .player-group { position: absolute; bottom: 160px; display: flex; gap: 40px; }

        .unit {
            width: 110px; /*ç¨å¾®åŠ å®½ä»¥é€‚åº”å›¾ç‰‡*/
            text-align: center;
            position: relative;
            transition: transform 0.2s;
            cursor: default;
        }

        .unit.active { transform: scale(1.1); z-index: 5; }
        
        .unit.selectable { cursor: pointer; animation: pulse 1s infinite; }
        .unit.selectable:hover { filter: brightness(1.3); transform: scale(1.15); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }
        
        /* é€‰ä¸­å…‰åœˆ */
        .unit.active .unit-avatar {
            box-shadow: 0 0 15px var(--sp-color);
            border-color: var(--sp-color);
        }

        .unit-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: #444;
            margin: 0 auto 10px;
            border: 3px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            position: relative;
            overflow: hidden; /* å…³é”®ï¼šè£å‰ªè¶…å‡ºåœ†å½¢çš„å›¾ç‰‡ */
            background-size: cover;
        }
        
        /* å›¾ç‰‡é€‚é…ç±» */
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ä¿è¯å›¾ç‰‡å¡«æ»¡åœ†åœˆä¸”ä¸å˜å½¢ */
        }

        /* æŠ¤ç›¾å›¾æ ‡ */
        .shield-icon {
            position: absolute;
            top: 5px; /* è°ƒæ•´ä½ç½®é¿å…é®æŒ¡å¸…æ°”çš„è„¸ */
            right: 5px;
            width: 25px;
            height: 25px;
            background: var(--shield-color);
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 5px black;
            z-index: 10;
        }

        /* è¡€æ¡ä¸éŸ§æ€§ */
        .bar-container { width: 100%; height: 8px; background: #333; margin-top: 4px; border-radius: 4px; overflow: hidden; position: relative; }
        .hp-bar { height: 100%; background: var(--hp-color); transition: width 0.3s; position: absolute; top:0; left:0; z-index: 1;}
        .shield-bar { height: 100%; background: var(--shield-color); transition: width 0.3s; position: absolute; top:0; left:0; width: 0%; z-index: 2; opacity: 0.7; border-right: 1px solid white;}
        .enemy-hp-bar { background: var(--enemy-hp); }
        .toughness-bar { height: 100%; background: var(--toughness-color); transition: width 0.3s; position: relative; z-index: 1;}

        /* åº•éƒ¨æ“ä½œé¢æ¿ */
        #control-panel {
            position: absolute; bottom: 0; width: 100%; height: 130px;
            background: var(--ui-panel); display: flex; justify-content: space-between; 
            align-items: center; padding: 0 50px; box-sizing: border-box; border-top: 1px solid #444; z-index: 20; 
        }

        .sp-display { display: flex; gap: 6px; align-items: center; }
        .sp-dot { width: 14px; height: 14px; background: #333; border: 1px solid #666; transform: rotate(45deg); margin: 0 2px; }
        .sp-dot.active { background: var(--sp-color); box-shadow: 0 0 8px var(--sp-color); border-color: #fff; }

        .skills-wrapper { display: flex; gap: 25px; margin-right: 50px;}
        .skill-btn {
            width: 85px; height: 85px; border-radius: 50%; border: 2px solid #666;
            background: #222; color: white; cursor: pointer; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s; position: relative;
        }
        .skill-btn:hover:not(:disabled) { transform: scale(1.1); border-color: white; background: #333; }
        .skill-btn:active:not(:disabled) { transform: scale(0.95); }
        .skill-btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%); }

        .damage-text {
            position: absolute; color: white; font-size: 28px; font-weight: bold;
            text-shadow: 0 0 5px red; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 100;
        }
        .shield-text { color: #5dade2; text-shadow: 0 0 5px blue; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }

        #log-window {
            position: absolute; top: 10px; right: 10px; width: 300px; height: 120px;
            background: rgba(0,0,0,0.6); color: #ddd; font-size: 12px; padding: 10px;
            overflow-y: auto; pointer-events: none; border-radius: 5px;
        }
        
        #instruction-text {
            position: absolute; bottom: 140px; width: 100%; text-align: center;
            font-size: 20px; color: #5dade2; font-weight: bold; text-shadow: 0 0 5px black; display: none;
        }
    </style>
</head>
<body>

    <div id="action-bar-container">
        <div style="text-align: center; color:#aaa; font-size:12px; margin-bottom:10px;">è¡ŒåŠ¨åºåˆ—</div>
        <div id="action-list"></div>
    </div>

    <div id="battle-field">
        <div id="log-window"></div>
        <div id="instruction-text">è¯·é€‰æ‹©è¦æ–½åŠ æŠ¤ç›¾çš„é˜Ÿå‹...</div>
        
        <div class="enemy-group" id="enemy-container"></div>
        <div class="player-group" id="player-container"></div>
    </div>

    <div id="control-panel">
        <div class="panel-left">
            <div style="font-size: 14px; color: #aaa; margin-bottom: 8px;">æˆ˜æŠ€ç‚¹ (SP)</div>
            <div class="sp-display" id="sp-container"></div>
        </div>

        <div id="turn-msg" style="font-size: 20px; font-weight: bold; color: #fff;"></div>

        <div class="skills-wrapper">
            <button class="skill-btn" id="btn-basic" onclick="game.playerAction('basic')">
                <span style="font-size:12px; color:#aaa;">æ™®é€šæ”»å‡»</span>
                <span style="font-size:18px; font-weight:bold;">Q</span>
                <span style="font-size:10px; color:#2ecc71; margin-top:2px;">SP +1</span>
            </button>
            
            <button class="skill-btn" id="btn-skill" onclick="game.playerAction('skill')">
                <span style="font-size:12px; color:#aaa;">æˆ˜æŠ€</span>
                <span style="font-size:18px; font-weight:bold;">E</span>
                <span style="font-size:10px; color:#e74c3c; margin-top:2px;">SP -1</span>
            </button>
        </div>
    </div>

    <script>
        class Unit {
            constructor(id, name, hp, toughness, speed, type, avatarHtml) {
                this.id = id;
                this.name = name;
                this.maxHp = hp;
                this.currentHp = hp;
                this.maxToughness = toughness;
                this.currentToughness = toughness;
                this.speed = speed;
                this.type = type; 
                this.avatarHtml = avatarHtml; // è¿™é‡Œç›´æ¥å­˜å‚¨HTMLå­—ç¬¦ä¸²
                this.actionValue = 10000 / speed; 
                this.isBroken = false;
                this.shield = 0;
            }
        }

        const game = {
            skillPoints: 3,
            maxSkillPoints: 5,
            units: [],
            isPlayerTurn: false,
            activeUnit: null,
            isSelectingTarget: false, 
            pendingSkill: null, 

            init: function() {
                // === è¿™é‡Œæ˜¯å›¾ç‰‡é…ç½®çš„å…³é”® ===
                // æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ <img src="æ–‡ä»¶å"> æ ‡ç­¾
                this.units = [
                    new Unit(1, "å¼€æ‹“è€…", 1200, 0, 100, 'player', '<img src="mc.png" class="avatar-img" onerror="this.style.display=\'none\'">'),
                    new Unit(2, "ä¸‰æœˆä¸ƒ", 1000, 0, 98, 'player', '<img src="march7.png" class="avatar-img" onerror="this.style.display=\'none\'">'), 
                    // æ•Œäººä¾ç„¶ä¿æŒ Emoji
                    new Unit(3, "è™šå’", 3000, 90, 95, 'enemy', 'ğŸ‘¾')
                ];

                this.renderStaticUI();
                this.log("èµ„æºåŠ è½½ä¸­...æˆ˜æ–—å¼€å§‹ï¼");
                this.nextTurn();
            },

            nextTurn: function() {
                this.isSelectingTarget = false;
                document.getElementById('instruction-text').style.display = 'none';

                this.units.sort((a, b) => a.actionValue - b.actionValue);
                const current = this.units[0];
                const elapsed = current.actionValue;

                this.units.forEach(u => {
                    u.actionValue = Math.max(0, u.actionValue - elapsed);
                    if(u === current && u.isBroken) {
                        u.isBroken = false;
                        u.currentToughness = u.maxToughness;
                        this.log(`${u.name} æ¢å¤äº†éŸ§æ€§ï¼`);
                    }
                });

                current.actionValue = 10000 / current.speed;
                this.activeUnit = current;

                this.updateUI();

                const msg = document.getElementById('turn-msg');
                
                if (current.type === 'player') {
                    this.isPlayerTurn = true;
                    msg.innerText = `ğŸ‘‰ ${current.name} çš„å›åˆ`;
                    msg.style.color = "#3498db";
                    this.toggleButtons(true);
                } else {
                    this.isPlayerTurn = false;
                    msg.innerText = `âš ï¸ ${current.name} è¡ŒåŠ¨ä¸­...`;
                    msg.style.color = "#e74c3c";
                    this.toggleButtons(false);
                    setTimeout(() => this.enemyAction(), 1000);
                }
            },

            playerAction: function(actionType) {
                if (!this.isPlayerTurn) return;

                const actor = this.activeUnit;
                const enemy = this.units.find(u => u.type === 'enemy' && u.currentHp > 0);

                if (actionType === 'basic') {
                    this.dealDamage(enemy, 200, 30);
                    this.changeSP(1);
                    this.log(`${actor.name} ä½¿ç”¨æ™®æ”»`);
                    this.finishPlayerTurn();
                } 
                else if (actionType === 'skill') {
                    if (this.skillPoints <= 0) {
                        alert("æˆ˜æŠ€ç‚¹ä¸è¶³ï¼"); return;
                    }

                    if (actor.name === "ä¸‰æœˆä¸ƒ") {
                        this.isSelectingTarget = true;
                        this.pendingSkill = 'march_shield';
                        this.log("è¯·é€‰æ‹©ä¸€åé˜Ÿå‹æ–½åŠ æŠ¤ç›¾...");
                        document.getElementById('instruction-text').style.display = 'block';
                        this.updateUI(); 
                        return; 
                    } else {
                        this.changeSP(-1);
                        this.dealDamage(enemy, 450, 60);
                        this.log(`${actor.name} ä½¿ç”¨æˆ˜æŠ€`);
                        this.finishPlayerTurn();
                    }
                }
            },

            selectUnit: function(targetId) {
                if (!this.isSelectingTarget) return;

                const target = this.units.find(u => u.id === targetId);
                const actor = this.activeUnit;

                if (this.pendingSkill === 'march_shield') {
                    if (target.type !== 'player') {
                        alert("åªèƒ½ç»™é˜Ÿå‹åŠ ç›¾ï¼"); return;
                    }
                    const shieldAmount = 450;
                    target.shield += shieldAmount; 
                    this.changeSP(-1);
                    this.log(`âœ¨ ä¸‰æœˆä¸ƒç»™ ${target.name} æä¾›äº†æŠ¤ç›¾ï¼`);
                    this.showFloatingText(target.id, `æŠ¤ç›¾ +${shieldAmount}`, "#5dade2");
                    this.isSelectingTarget = false;
                    document.getElementById('instruction-text').style.display = 'none';
                    this.finishPlayerTurn();
                }
            },

            finishPlayerTurn: function() {
                this.isPlayerTurn = false; 
                this.toggleButtons(false);
                setTimeout(() => this.checkWinCondition(), 800);
            },

            enemyAction: function() {
                const enemy = this.activeUnit;
                if(enemy.currentHp <= 0) { this.nextTurn(); return; }

                const players = this.units.filter(u => u.type === 'player' && u.currentHp > 0);
                if (players.length === 0) return;

                // å˜²è®½é€»è¾‘
                let lotteryPool = [];
                players.forEach(p => {
                    lotteryPool.push(p); 
                    if (p.shield > 0) {
                        lotteryPool.push(p); lotteryPool.push(p); lotteryPool.push(p);
                    }
                });

                const victim = lotteryPool[Math.floor(Math.random() * lotteryPool.length)];
                this.log(`${enemy.name} æ”»å‡»äº† ${victim.name} ` + (victim.shield > 0 ? "(å˜²è®½ç”Ÿæ•ˆ!)" : ""));
                this.dealDamage(victim, 250, 0); 
                this.checkWinCondition();
            },

            dealDamage: function(target, dmg, breakVal) {
                if (target.shield > 0) {
                    const absorbed = Math.min(target.shield, dmg);
                    target.shield -= absorbed;
                    dmg -= absorbed; 
                    this.showFloatingText(target.id, `æŠµæ¶ˆ ${Math.floor(absorbed)}`, "#5dade2");
                    if (target.shield <= 0) {
                         this.log(`${target.name} çš„æŠ¤ç›¾ç ´ç¢äº†ï¼`);
                         target.shield = 0;
                    }
                }
                if (dmg > 0) {
                    let finalDmg = target.isBroken ? dmg * 1.5 : dmg;
                    if (target.type === 'enemy' && !target.isBroken && breakVal > 0) {
                        target.currentToughness -= breakVal;
                        if (target.currentToughness <= 0) {
                            target.currentToughness = 0;
                            target.isBroken = true;
                            finalDmg += 500; 
                            this.showFloatingText(target.id, "å‡»ç ´!", "#ffd700");
                            this.log(`ğŸ’¥ ${target.name} å¼±ç‚¹è¢«å‡»ç ´ï¼`);
                        }
                    }
                    target.currentHp = Math.max(0, target.currentHp - finalDmg);
                    this.showFloatingText(target.id, Math.floor(finalDmg), "#fff");
                } 
                this.updateUI();
            },

            checkWinCondition: function() {
                const enemyAlive = this.units.some(u => u.type === 'enemy' && u.currentHp > 0);
                const playerAlive = this.units.some(u => u.type === 'player' && u.currentHp > 0);
                if (!enemyAlive) { alert("ğŸ† æˆ˜æ–—èƒœåˆ©ï¼"); location.reload(); } 
                else if (!playerAlive) { alert("â˜ ï¸ å…¨å‘˜é˜µäº¡..."); location.reload(); } 
                else { this.nextTurn(); }
            },

            changeSP: function(val) {
                this.skillPoints += val;
                if(this.skillPoints > this.maxSkillPoints) this.skillPoints = this.maxSkillPoints;
                if(this.skillPoints < 0) this.skillPoints = 0;
                this.updateUI();
            },

            log: function(text) {
                const win = document.getElementById('log-window');
                win.innerHTML += `<div>> ${text}</div>`;
                win.scrollTop = win.scrollHeight;
            },

            renderStaticUI: function() {
                const spCont = document.getElementById('sp-container');
                spCont.innerHTML = '';
                for(let i=0; i<this.maxSkillPoints; i++) {
                    let dot = document.createElement('div');
                    dot.className = 'sp-dot';
                    spCont.appendChild(dot);
                }
                
                const pDiv = document.getElementById('player-container');
                const eDiv = document.getElementById('enemy-container');
                
                this.units.forEach(u => {
                    const html = `
                        <div id="unit-${u.id}" class="unit" onclick="game.selectUnit(${u.id})">
                            ${u.type === 'enemy' ? '<div class="bar-container" style="background:#555"><div class="toughness-bar" style="width:100%"></div></div>' : ''}
                            
                            <div class="unit-avatar">
                                ${u.avatarHtml}
                                <div class="shield-icon" style="display:none">ğŸ›¡ï¸</div>
                            </div>
                            
                            <div class="bar-container">
                                <div class="hp-bar ${u.type === 'enemy' ? 'enemy-hp-bar':''}" style="width:100%"></div>
                                <div class="shield-bar"></div> 
                            </div>
                            <div style="font-size:12px; margin-top:2px;">${u.name}</div>
                        </div>
                    `;
                    if(u.type === 'player') pDiv.innerHTML += html;
                    else eDiv.innerHTML += html;
                });
            },

            updateUI: function() {
                this.units.forEach(u => {
                    const el = document.getElementById(`unit-${u.id}`);
                    if(!el) return;
                    
                    const hpPct = (u.currentHp / u.maxHp) * 100;
                    el.querySelector('.hp-bar').style.width = hpPct + '%';
                    const shieldPct = Math.min((u.shield / 1000) * 100, 100);
                    const shieldBar = el.querySelector('.shield-bar');
                    shieldBar.style.width = shieldPct + '%';
                    
                    if(u.shield > 0) el.querySelector('.shield-icon').style.display = 'flex';
                    else el.querySelector('.shield-icon').style.display = 'none';

                    if(u.type === 'enemy') {
                        const tPct = (u.currentToughness / u.maxToughness) * 100;
                        el.querySelector('.toughness-bar').style.width = tPct + '%';
                    }

                    el.classList.remove('active', 'selectable');
                    if(this.activeUnit && u.id === this.activeUnit.id) el.classList.add('active');
                    if (this.isSelectingTarget && u.type === 'player') el.classList.add('selectable');
                });

                const dots = document.querySelectorAll('.sp-dot');
                dots.forEach((dot, idx) => {
                    if(idx < this.skillPoints) dot.classList.add('active');
                    else dot.classList.remove('active');
                });

                const actionList = document.getElementById('action-list');
                actionList.innerHTML = '';
                let predictList = [...this.units].sort((a,b) => a.actionValue - b.actionValue);
                predictList.forEach(u => {
                    let div = document.createElement('div');
                    div.className = `action-card ${this.activeUnit && u.id === this.activeUnit.id ? 'active' : ''}`;
                    // åœ¨è¡ŒåŠ¨æ¡ä¸­ä¹Ÿæ˜¾ç¤ºå›¾ç‰‡
                    div.innerHTML = `${u.avatarHtml} <div style="font-size:10px; color:#aaa">${Math.floor(u.actionValue)}</div>`;
                    actionList.appendChild(div);
                });

                const btnSkill = document.getElementById('btn-skill');
                const btnBasic = document.getElementById('btn-basic');
                if(this.skillPoints <= 0) btnSkill.disabled = true;
                else if(this.isPlayerTurn) btnSkill.disabled = false;
            },

            toggleButtons: function(enable) {
                const btnSkill = document.getElementById('btn-skill');
                const btnBasic = document.getElementById('btn-basic');
                btnBasic.disabled = !enable;
                if (!enable || this.skillPoints <= 0) btnSkill.disabled = true;
                else btnSkill.disabled = false;
            },

            showFloatingText: function(unitId, text, color) {
                const unitEl = document.getElementById(`unit-${unitId}`);
                if(!unitEl) return;
                let div = document.createElement('div');
                div.className = 'damage-text';
                if(color === '#5dade2') div.classList.add('shield-text');
                div.innerText = text;
                div.style.color = color || 'white';
                div.style.left = '20%';
                div.style.top = '-20px';
                unitEl.appendChild(div);
                setTimeout(() => div.remove(), 800);
            }
        };

        window.onload = function() {
            try { game.init(); 
                document.addEventListener('keydown', (e) => {
                    if (game.isPlayerTurn && !game.isSelectingTarget) {
                        if (e.key.toLowerCase() === 'q') game.playerAction('basic');
                        if (e.key.toLowerCase() === 'e') game.playerAction('skill');
                    }
                });
            } catch (e) { console.error(e); }
        };
    </script>
</body>
</html>
