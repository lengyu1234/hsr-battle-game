<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ˜Ÿç©¹é“é“æˆ˜æ–—æ¨¡æ‹Ÿå™¨ (ä¿®å¤ç‰ˆ)</title>
    <style>
        /* === æ ·å¼è¡¨ === */
        :root {
            --bg-color: #0d1117;
            --ui-panel: rgba(22, 27, 34, 0.95);
            --sp-color: #ffd700;
            --hp-color: #2ecc71;
            --enemy-hp: #e74c3c;
            --toughness-color: #ecf0f1;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            user-select: none;
        }

        /* å·¦ä¾§è¡ŒåŠ¨æ¡ */
        #action-bar-container {
            width: 110px;
            background: rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 1px solid #333;
            z-index: 10;
        }

        .action-card {
            background: #2c3e50;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 2px solid transparent;
            transition: transform 0.3s;
        }
        
        .action-card.active {
            border-color: var(--sp-color);
            background: #34495e;
            transform: scale(1.05);
        }

        /* æˆ˜æ–—ä¸»åŒºåŸŸ */
        #battle-field {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
        }

        .enemy-group { display: flex; gap: 30px; margin-bottom: 120px; }
        .player-group { position: absolute; bottom: 160px; display: flex; gap: 40px; }

        .unit {
            width: 100px;
            text-align: center;
            position: relative;
            transition: transform 0.2s;
        }

        .unit.active { transform: scale(1.1); z-index: 5; }
        
        /* é€‰ä¸­å…‰åœˆ */
        .unit.active .unit-avatar {
            box-shadow: 0 0 15px var(--sp-color);
            border-color: var(--sp-color);
        }

        .unit-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #444;
            margin: 0 auto 10px;
            border: 3px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        /* è¡€æ¡ä¸éŸ§æ€§ */
        .bar-container { width: 100%; height: 6px; background: #333; margin-top: 4px; border-radius: 3px; overflow: hidden; }
        .hp-bar { height: 100%; background: var(--hp-color); transition: width 0.3s; }
        .enemy-hp-bar { background: var(--enemy-hp); }
        .toughness-bar { height: 100%; background: var(--toughness-color); transition: width 0.3s; }

        /* åº•éƒ¨æ“ä½œé¢æ¿ */
        #control-panel {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 130px;
            background: var(--ui-panel);
            display: flex;
            justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
            align-items: center;
            padding: 0 50px;
            box-sizing: border-box;
            border-top: 1px solid #444;
            z-index: 20; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
        }

        /* æˆ˜æŠ€ç‚¹ */
        .sp-display { display: flex; gap: 6px; align-items: center; }
        .sp-dot { width: 14px; height: 14px; background: #333; border: 1px solid #666; transform: rotate(45deg); margin: 0 2px; }
        .sp-dot.active { background: var(--sp-color); box-shadow: 0 0 8px var(--sp-color); border-color: #fff; }

        /* æŠ€èƒ½æŒ‰é’® */
        .skills-wrapper { display: flex; gap: 25px; margin-right: 50px;}
        
        .skill-btn {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            border: 2px solid #666;
            background: #222;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .skill-btn:hover:not(:disabled) { transform: scale(1.1); border-color: white; background: #333; }
        .skill-btn:active:not(:disabled) { transform: scale(0.95); }
        .skill-btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%); }

        /* ä¼¤å®³æ•°å­—åŠ¨ç”» */
        .damage-text {
            position: absolute; color: white; font-size: 28px; font-weight: bold;
            text-shadow: 0 0 5px red; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 100;
        }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }

        /* æ—¥å¿—çª—å£ */
        #log-window {
            position: absolute; top: 10px; right: 10px; width: 300px; height: 120px;
            background: rgba(0,0,0,0.6); color: #ddd; font-size: 12px; padding: 10px;
            overflow-y: auto; pointer-events: none; border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="action-bar-container">
        <div style="text-align: center; color:#aaa; font-size:12px; margin-bottom:10px;">è¡ŒåŠ¨åºåˆ—</div>
        <div id="action-list"></div>
    </div>

    <div id="battle-field">
        <div id="log-window"></div>
        
        <div class="enemy-group" id="enemy-container"></div>
        
        <div class="player-group" id="player-container"></div>
    </div>

    <div id="control-panel">
        <div class="panel-left">
            <div style="font-size: 14px; color: #aaa; margin-bottom: 8px;">æˆ˜æŠ€ç‚¹ (SP)</div>
            <div class="sp-display" id="sp-container">
                </div>
        </div>

        <div id="turn-msg" style="font-size: 20px; font-weight: bold; color: #fff;"></div>

        <div class="skills-wrapper">
            <button class="skill-btn" id="btn-basic" onclick="game.playerAction('basic')">
                <span style="font-size:12px; color:#aaa;">æ™®é€šæ”»å‡»</span>
                <span style="font-size:18px; font-weight:bold;">Q</span>
                <span style="font-size:10px; color:#2ecc71; margin-top:2px;">SP +1</span>
            </button>
            
            <button class="skill-btn" id="btn-skill" onclick="game.playerAction('skill')">
                <span style="font-size:12px; color:#aaa;">æˆ˜æŠ€</span>
                <span style="font-size:18px; font-weight:bold;">E</span>
                <span style="font-size:10px; color:#e74c3c; margin-top:2px;">SP -1</span>
            </button>
        </div>
    </div>

    <script>
        // === 1. æ ¸å¿ƒæ•°æ®ç±» ===
        class Unit {
            constructor(id, name, hp, toughness, speed, type, avatar) {
                this.id = id;
                this.name = name;
                this.maxHp = hp;
                this.currentHp = hp;
                this.maxToughness = toughness;
                this.currentToughness = toughness;
                this.speed = speed;
                this.type = type; 
                this.avatar = avatar;
                this.actionValue = 10000 / speed; 
                this.isBroken = false;
            }
        }

        // === 2. æ¸¸æˆæ§åˆ¶å™¨ ===
        const game = {
            skillPoints: 3,
            maxSkillPoints: 5,
            units: [],
            isPlayerTurn: false,
            activeUnit: null,

            // åˆå§‹åŒ–
            init: function() {
                // åˆ›å»ºè§’è‰²ï¼šé€Ÿåº¦è¶Šå¿« AV è¶Šå°ï¼Œè¶Šå…ˆå‡ºæ‰‹
                this.units = [
                    new Unit(1, "å¼€æ‹“è€…", 1200, 0, 100, 'player', 'ğŸ'),
                    new Unit(2, "ä¸‰æœˆä¸ƒ", 1000, 0, 125, 'player', 'ğŸ¹'), // é€Ÿåº¦å¿«
                    new Unit(3, "è™šå’", 3000, 90, 95, 'enemy', 'ğŸ‘¾')
                ];

                this.renderStaticUI();
                this.log("ç³»ç»ŸåŠ è½½å®Œæˆ...æˆ˜æ–—å¼€å§‹ï¼");
                this.nextTurn();
            },

            // å›åˆè®¡ç®—æ ¸å¿ƒé€»è¾‘
            nextTurn: function() {
                // 1. æ’åºï¼šæ‰¾AVæœ€å°çš„å•ä½
                this.units.sort((a, b) => a.actionValue - b.actionValue);
                const current = this.units[0];
                const elapsed = current.actionValue;

                // 2. è·‘æ¡ï¼šæ‰€æœ‰å•ä½å‡å»ç»è¿‡çš„æ—¶é—´
                this.units.forEach(u => {
                    u.actionValue = Math.max(0, u.actionValue - elapsed);
                    // ç®€å•çš„å‡»ç ´æ¢å¤é€»è¾‘
                    if(u === current && u.isBroken) {
                        u.isBroken = false;
                        u.currentToughness = u.maxToughness;
                        this.log(`${u.name} æ¢å¤äº†éŸ§æ€§ï¼`);
                    }
                });

                // 3. é‡ç½®å½“å‰å•ä½çš„AV (è·‘å®Œä¸€åœˆå›èµ·ç‚¹)
                current.actionValue = 10000 / current.speed;
                this.activeUnit = current;

                // 4. æ›´æ–°UI
                this.updateUI();

                // 5. åˆ¤æ–­è¡ŒåŠ¨æ–¹
                const msg = document.getElementById('turn-msg');
                
                if (current.type === 'player') {
                    this.isPlayerTurn = true;
                    msg.innerText = `ğŸ‘‰ ${current.name} çš„å›åˆ`;
                    msg.style.color = "#3498db";
                    this.toggleButtons(true);
                } else {
                    this.isPlayerTurn = false;
                    msg.innerText = `âš ï¸ ${current.name} è¡ŒåŠ¨ä¸­...`;
                    msg.style.color = "#e74c3c";
                    this.toggleButtons(false);
                    // å»¶è¿Ÿæ¨¡æ‹Ÿæ•ŒäººAI
                    setTimeout(() => this.enemyAction(), 1000);
                }
            },

            // ç©å®¶ç‚¹å‡»äº‹ä»¶
            playerAction: function(actionType) {
                if (!this.isPlayerTurn) {
                    console.log("ç°åœ¨ä¸æ˜¯ä½ çš„å›åˆï¼Œæ— æ³•ç‚¹å‡»");
                    return;
                }

                // è‡ªåŠ¨é”å®šä¸€ä¸ªæ´»ç€çš„æ•Œäºº
                const target = this.units.find(u => u.type === 'enemy' && u.currentHp > 0);
                if (!target) { alert("æ•Œäººå·²æ¶ˆç­ï¼"); return; }

                const actor = this.activeUnit;

                if (actionType === 'basic') {
                    // æ™®æ”»ï¼šå›ç«ï¼Œä½ä¼¤å®³ï¼Œä½å‰ŠéŸ§
                    this.dealDamage(target, 200, 30);
                    this.changeSP(1);
                    this.log(`${actor.name} ä½¿ç”¨æ™®æ”»`);
                } 
                else if (actionType === 'skill') {
                    // æˆ˜æŠ€ï¼šè€—ç«ï¼Œé«˜ä¼¤å®³ï¼Œé«˜å‰ŠéŸ§
                    if (this.skillPoints <= 0) {
                        alert("æˆ˜æŠ€ç‚¹ä¸è¶³ï¼è¯·ä½¿ç”¨æ™®æ”»å›ç‚¹ã€‚");
                        return;
                    }
                    this.changeSP(-1);
                    this.dealDamage(target, 450, 60);
                    this.log(`${actor.name} ä½¿ç”¨æˆ˜æŠ€`);
                }

                // è¡ŒåŠ¨ç»“æŸ
                this.isPlayerTurn = false; 
                this.toggleButtons(false);
                setTimeout(() => this.checkWinCondition(), 500);
            },

            // æ•ŒäººAI
            enemyAction: function() {
                const enemy = this.activeUnit;
                if(enemy.currentHp <= 0) { this.nextTurn(); return; }

                // éšæœºæ”»å‡»ä¸€ä¸ªç©å®¶
                const targets = this.units.filter(u => u.type === 'player' && u.currentHp > 0);
                if (targets.length > 0) {
                    const victim = targets[Math.floor(Math.random() * targets.length)];
                    this.log(`${enemy.name} æ”»å‡»äº† ${victim.name}`);
                    this.dealDamage(victim, 150, 0); // æ•Œäººæš‚æ—¶ä¸å‰ŠéŸ§ç©å®¶
                }
                this.checkWinCondition();
            },

            // é€ æˆä¼¤å®³ä¸å‰ŠéŸ§
            dealDamage: function(target, dmg, breakVal) {
                // å‡»ç ´å€ç‡
                let finalDmg = target.isBroken ? dmg * 1.5 : dmg;
                
                // å‰ŠéŸ§é€»è¾‘
                if (target.type === 'enemy' && !target.isBroken && breakVal > 0) {
                    target.currentToughness -= breakVal;
                    if (target.currentToughness <= 0) {
                        target.currentToughness = 0;
                        target.isBroken = true;
                        finalDmg += 500; // å‡»ç ´é¢å¤–ä¼¤å®³
                        this.showFloatingText(target.id, "å‡»ç ´!", "#ffd700");
                        this.log(`ğŸ’¥ ${target.name} å¼±ç‚¹è¢«å‡»ç ´ï¼`);
                    }
                }

                target.currentHp = Math.max(0, target.currentHp - finalDmg);
                this.showFloatingText(target.id, Math.floor(finalDmg), "#fff");
                this.updateUI();
            },

            // æ£€æŸ¥èƒœè´Ÿ
            checkWinCondition: function() {
                const enemyAlive = this.units.some(u => u.type === 'enemy' && u.currentHp > 0);
                const playerAlive = this.units.some(u => u.type === 'player' && u.currentHp > 0);

                if (!enemyAlive) {
                    alert("ğŸ† æˆ˜æ–—èƒœåˆ©ï¼");
                    location.reload();
                } else if (!playerAlive) {
                    alert("â˜ ï¸ å…¨å‘˜é˜µäº¡ï¼Œè¯·æŒ‰F5é‡è¯•...");
                } else {
                    // æ¸¸æˆç»§ç»­ï¼Œä¸‹ä¸€å›åˆ
                    this.nextTurn();
                }
            },

            // === è¾…åŠ©åŠŸèƒ½ ===
            changeSP: function(val) {
                this.skillPoints += val;
                if(this.skillPoints > this.maxSkillPoints) this.skillPoints = this.maxSkillPoints;
                if(this.skillPoints < 0) this.skillPoints = 0;
                this.updateUI(); // åˆ·æ–°UIæ˜¾ç¤º
            },

            log: function(text) {
                const win = document.getElementById('log-window');
                win.innerHTML += `<div>> ${text}</div>`;
                win.scrollTop = win.scrollHeight;
            },

            // === UI æ¸²æŸ“ ===
            renderStaticUI: function() {
                // æ¸²æŸ“æˆ˜æŠ€ç‚¹ç‚¹æ•° DOM
                const spCont = document.getElementById('sp-container');
                spCont.innerHTML = '';
                for(let i=0; i<this.maxSkillPoints; i++) {
                    let dot = document.createElement('div');
                    dot.className = 'sp-dot';
                    spCont.appendChild(dot);
                }
                
                // æ¸²æŸ“åˆå§‹å•ä½æ¨¡å‹
                const pDiv = document.getElementById('player-container');
                const eDiv = document.getElementById('enemy-container');
                
                this.units.forEach(u => {
                    const html = `
                        <div id="unit-${u.id}" class="unit">
                            ${u.type === 'enemy' ? '<div class="bar-container" style="background:#555"><div class="toughness-bar" style="width:100%"></div></div>' : ''}
                            <div class="unit-avatar">${u.avatar}</div>
                            <div class="bar-container"><div class="hp-bar ${u.type === 'enemy' ? 'enemy-hp-bar':''}" style="width:100%"></div></div>
                            <div style="font-size:12px; margin-top:2px;">${u.name}</div>
                        </div>
                    `;
                    if(u.type === 'player') pDiv.innerHTML += html;
                    else eDiv.innerHTML += html;
                });
            },

            updateUI: function() {
                // 1. æ›´æ–°è¡€æ¡/éŸ§æ€§æ¡
                this.units.forEach(u => {
                    const el = document.getElementById(`unit-${u.id}`);
                    if(!el) return;
                    
                    const hpPct = (u.currentHp / u.maxHp) * 100;
                    el.querySelector('.hp-bar').style.width = hpPct + '%';
                    
                    if(u.type === 'enemy') {
                        const tPct = (u.currentToughness / u.maxToughness) * 100;
                        el.querySelector('.toughness-bar').style.width = tPct + '%';
                    }

                    // æ¿€æ´»é«˜äº®
                    if(this.activeUnit && u.id === this.activeUnit.id) el.classList.add('active');
                    else el.classList.remove('active');
                });

                // 2. æ›´æ–°æˆ˜æŠ€ç‚¹
                const dots = document.querySelectorAll('.sp-dot');
                dots.forEach((dot, idx) => {
                    if(idx < this.skillPoints) dot.classList.add('active');
                    else dot.classList.remove('active');
                });

                // 3. æ›´æ–°å·¦ä¾§è¡ŒåŠ¨æ¡
                const actionList = document.getElementById('action-list');
                actionList.innerHTML = '';
                // å¤åˆ¶å¹¶é¢„æµ‹ä¸‹ä¸€æ¬¡è¡ŒåŠ¨
                let predictList = [...this.units].sort((a,b) => a.actionValue - b.actionValue);
                predictList.forEach(u => {
                    let div = document.createElement('div');
                    div.className = `action-card ${this.activeUnit && u.id === this.activeUnit.id ? 'active' : ''}`;
                    div.innerHTML = `<div>${u.avatar} ${u.name}</div><div style="font-size:10px; color:#aaa">${Math.floor(u.actionValue)} AV</div>`;
                    actionList.appendChild(div);
                });

                // 4. æŒ‰é’®çŠ¶æ€æ§åˆ¶
                const btnSkill = document.getElementById('btn-skill');
                const btnBasic = document.getElementById('btn-basic');
                
                // å¦‚æœä¸æ˜¯ç©å®¶å›åˆï¼ŒCSSæ ·å¼ä¸Šå˜ç°ï¼Œä½†å®é™…ç”± toggleButtons æ§åˆ¶ç‚¹å‡»
                if(this.skillPoints <= 0) btnSkill.disabled = true;
                else if(this.isPlayerTurn) btnSkill.disabled = false;
            },

            toggleButtons: function(enable) {
                const btnSkill = document.getElementById('btn-skill');
                const btnBasic = document.getElementById('btn-basic');
                btnBasic.disabled = !enable;
                // æˆ˜æŠ€è¿˜è¦é¢å¤–åˆ¤æ–­ç‚¹æ•°
                if (!enable || this.skillPoints <= 0) {
                    btnSkill.disabled = true;
                } else {
                    btnSkill.disabled = false;
                }
            },

            showFloatingText: function(unitId, text, color) {
                const unitEl = document.getElementById(`unit-${unitId}`);
                if(!unitEl) return;
                let div = document.createElement('div');
                div.className = 'damage-text';
                div.innerText = text;
                div.style.color = color || 'white';
                div.style.left = '50%';
                div.style.top = '0';
                unitEl.appendChild(div);
                setTimeout(() => div.remove(), 800);
            }
        };

        // === 3. å¯åŠ¨æ¸¸æˆ (ç¡®ä¿DOMåŠ è½½åæ‰§è¡Œ) ===
        window.onload = function() {
            try {
                game.init();
                // é”®ç›˜å¿«æ·é”®ç»‘å®š
                document.addEventListener('keydown', (e) => {
                    if (game.isPlayerTurn) {
                        if (e.key.toLowerCase() === 'q') game.playerAction('basic');
                        if (e.key.toLowerCase() === 'e') game.playerAction('skill');
                    }
                });
            } catch (e) {
                alert("æ¸¸æˆå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°(F12)");
                console.error(e);
            }
        };
    </script>
</body>
</html>
